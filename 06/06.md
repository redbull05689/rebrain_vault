sudo systemctl restart vault

vault -autocomplete-install

export VAULT_SKIP_VERIFY="true"

vault operator init -key-shares=3 -key-threshold=2

echo "hvs.4TOn6R5vD6jALuH8nxs8XI7B" > /home/user/root_token

export VAULT_TOKEN="hvs.4TOn6R5vD6jALuH8nxs8XI7B"

vault operator unseal
vault operator unseal

# List availible plugins
vault plugin list

# list availible database plugins
vault plugin list database

# In the Vault Server, enable a database secrets engine:
vault secrets enable database

# Mongo
vault write database/config/mongo-dev  plugin_name=mongodb-database-plugin \
allowed_roles="mongo-role" connection_url='mongodb://{{username}}:{{password}}@51.250.34.7:27017/admin?tls=false' \
username="mongouser" \
password="mongouser"

# See configuration
vault read database/config/mongo-dev  

vault write database/roles/mmongo-dev-role db_name="mongo-dev" \
creation_statements='{ "db": "admin", "roles": [{"role":"readWrite", "db": "vault-db"]' \
default_ttl="1h" \
max_ttl="2h"

# Read role
vault read database/roles/mongo-roles

# Read connection string
vault read database/config/mongo-dev 

vault read database/creds/mongo-role

# Postgresql
# In the Vault Server, grant access to the database:
vault write database/config/postgres-dev plugin_name=postgresql-database-plugin \
connection_url='postgresql://{{username}}:{{password}}@51.250.34.7:5432/postgres?sslmode=disable' \
allowed_roles='postgres-dev-role' \
username='vault' password='vaultpass'

# Create a user with access to the test_table:
vault write database/roles/postgres-dev-role \
db_name=postgres-dev \
creation_statements="CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; GRANT USAGE ON SCHEMA stage_schema TO "{{name}}"; GRANT SELECT, UPDATE, INSERT ON ALL TABLES IN SCHEMA stage_schema TO "{{name}}";" \
default_ttl="30m" \
max_ttl="1h"

 tee postgres-dev.hcl<<EOF
{
  "max_versions": 10,
  "cas_required": true
}
EOF

vault policy write nomad-server postgres-dev.hcl